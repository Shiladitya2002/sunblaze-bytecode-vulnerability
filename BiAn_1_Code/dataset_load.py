from datasets import load_dataset
from pathlib import Path
from huggingface_hub import login
import os

output_dir = Path("C:\\Documents\\Dawn Song Lab\\Explore\\BiAn_1\\caches\\slither_dataset")

def findVersion(solCode):
    for i in range(0, len(solCode)):
        if solCode[i].isnumeric():
            end = min(solCode.find(' ', i), solCode.find(';', i))
            return solCode[i:end]

size = 10
RANDOM_SEED = 420
# Access HuggingFace Dataset
dataset = load_dataset("mwritescode/slither-audited-smart-contracts", "all-plain-text", split="train", streaming=True)
#dataset = dataset.shuffle(RANDOM_SEED, buffer_size=100000)
# Begin looping through files
at = 0
for testCase in dataset:
    if at >= size: break
    # Extract sol code and version
    filename = str(at)
    solcode = testCase["source_code"]
    version = findVersion(solcode)
    # Make version directory if needed and write to file
    os.makedirs(output_dir / version, exist_ok=True)
    with open(str(output_dir / version / filename), 'w', encoding="utf-8") as wf:
        wf.write(solcode)
    # Increment and print progress
    at+=1
    if at%100==0: print("# contracts loaded: " + str(at))
print("Wrote smart contracts: " + str(at))