import pickle
from pathlib import Path
from evm_cfg_builder import CFG
import sys

IN_FILE = Path("C:\\Documents\\Dawn Song Lab\\Explore\\CFG_1\\Output\\output1")
in_file = open(IN_FILE, "rb")
cfg_arr = pickle.load(in_file)
cfg = cfg_arr[0]['cfg']

for function in sorted(cfg.functions, key=lambda x: x.start_addr):
    print(f"Function {function.name}")
    # Each function may have a list of attributes
    # An attribute can be:
    # - payable
    # - view
    # - pure
    if sorted(function.attributes):
        print("\tAttributes:")
        for attr in function.attributes:
            print(f"\t\t-{attr}")

    print("\n\tBasic Blocks:")
    for basic_block in sorted(function.basic_blocks, key=lambda x: x.start.pc):
        print("\t\tInstructions:")
        for ins in basic_block.instructions:
            print(f"\t\t- {ins.name}")
        print("\t\tIncoming basic_block:")
        for incoming_bb in sorted(
            basic_block.incoming_basic_blocks(function.key), key=lambda x: x.start.pc
        ):
            print(f"\t\t- {incoming_bb}")

        print("\t\tOutgoing basic_block:")
        for outgoing_bb in sorted(
            basic_block.outgoing_basic_blocks(function.key), key=lambda x: x.start.pc
        ):
            print(f"\t\t- {outgoing_bb}")