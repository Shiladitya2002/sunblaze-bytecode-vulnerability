from pathlib import Path
from sklearn.feature_extraction.text import TfidfVectorizer
import os
import numpy as np
from IVPQIndex import *

dir = Path("C:\Documents\Dawn Song Lab\Explore\FAISS_1")
tfidf_model = TfidfVectorizer()
files = []
bytecodes = []

print("Begin Directory Walk")
for file in os.listdir(dir / "instructions"):
    with open(dir / "instructions" / file, "rb") as rf:
        data = rf.read()
    if len(data) == 0: continue
    print(file)

    data = data.decode('utf-8')
    inst = ' '.join(data[i:i+2] for i in range(0, len(data), 2))

    files.append(file)
    bytecodes.append(inst)

print("Extract TF-IDF Values")
tfidf_result = tfidf_model.fit_transform(bytecodes)
print(tfidf_model.get_feature_names_out())
tfidf_vector = np.array(tfidf_result.toarray())

print("Begin IVPQ Build + Save")
index =  IVPQIndex(tfidf_vector, files)
index.build()
index.save(dir / "tfidf-index.pkl")

