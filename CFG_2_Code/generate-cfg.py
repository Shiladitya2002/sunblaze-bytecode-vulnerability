import os
import subprocess
from pathlib import Path

size = 2000
input = Path("C:\\Documents\\Dawn Song Lab\\Explore\\CFG_1\\DeFiAttacksSoK\\dataset\\bytecodes\\adversarial\\eth")
output = Path("C:\\Documents\\Dawn Song Lab\\Explore\\CFG_2\\output")
cfgtool_directory = Path("C:\\Documents\\Dawn Song Lab\\Replicated Code\\plotchy-evm-cfg-main")
os.environ["RUST_BACKTRACE"]="1"

print("Begin Directory Walk")
base_command = "evm-cfg \"{input}\" -o \"{output}.dot\" --open"
out_obj = subprocess.Popen("cd " + str(cfgtool_directory), shell=True).wait()
at = 0
fails = 0
succeeds = 0
for file in os.listdir(input):
    if at==size: break
    bc_dir = str(input / file)
    cfg_dir = str(output / file)
    cfg_dir = cfg_dir[:cfg_dir.rindex(".")+1]
    out_obj = subprocess.Popen(base_command.format(input=bc_dir, output=cfg_dir), stdout=subprocess.PIPE, stderr=subprocess.STDOUT, shell=True)
    out_obj.wait()
    stdout = out_obj.communicate()[0].decode()

    if not ("Dot file saved to " + cfg_dir + ".dot") in stdout: 
        print("----------------------------------------------------------")
        print(stdout)
        print("FAILED: CFG not generated for: " + file)
        fails += 1
    else:
        #print("SUCCEEDED: CFG generated for: " + file)
        succeeds += 1
    at += 1

print("----------------------------------------------------------")
print("Successfully generated CFG for: " + str(succeeds))
print("Unsuccessful to generate CFG for: " + str(fails))